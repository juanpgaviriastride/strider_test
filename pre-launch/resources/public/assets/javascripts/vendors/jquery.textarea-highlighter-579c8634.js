var marexandre;!function(t,e,i){"use strict";var s="textareaHighlighter",n=new marexandre.Helper,o=function(e,s){this.$element=e,this.element=this.$element[0],this.settings=t.extend({},o.DEFAULTS,this.$element.data(),s),this.$wrapDiv=t(i.createElement("div")).addClass("textarea-highlighter-wrap"),this.$backgroundDiv=t(i.createElement("div")).addClass("background-div "+this.$element.attr("class")),this.$autoSize=t('<pre><div class="autosize"></div></pre>').addClass(this.$element.attr("class")).hide(),this.$autoSizeElement=this.$autoSize.find(".autosize"),this.init()};o.DEFAULTS={word_base:!0,matches:[],maxlength:-1,maxlengthWarning:"",maxlengthElement:null,isAutoExpand:!0,typingDelay:30,debug:!1},o.prototype.init=function(){for(var t=this,e=this.$element,i=this.settings,s=this.$wrapDiv,o=this.$backgroundDiv,r=0,a=i.matches.length;a>r;r++)i.matches[r].match=n.getUniqueArray(i.matches[r].match);t.updateStyle(),e.wrap(s).before(o),i.isAutoExpand&&e.after(t.$autoSize),t.updateHeight(),t.bindEvents(),t.highlight()},o.prototype.bindEvents=function(){var t=this,e=this.$element;if(e.data("highlighterTimerId",-1).on("scroll.textarea.highlighter",function(){t.$backgroundDiv.scrollTop(e.scrollTop())}),"onpropertychange"in t.element){var i=(new Date).getTime(),s=0,n=Math.abs;e.on("input.textarea.highlighter keyup.textarea.highlighter",function(e){s=n(i-(new Date).getTime()),s>10&&(t.change(e),i=(new Date).getTime())}),e.on("keydown.textarea.highlighter",function(e){s=n(i-(new Date).getTime()),8===e.which&&(10>s||s>250)&&(t.change(e),i=(new Date).getTime())})}else e.on("input.textarea.highlighter",function(e){t.change(e)})},o.prototype.change=function(t){var e=this;if(/(37|38|39|40)/.test(t.keyCode))return!0;e.updateHeight(),-1!==e.$element.data("highlighterTimerId")&&(clearTimeout(e.$element.data("highlighterTimerId")),e.$element.data("highlighterTimerId",-1));var i=setTimeout(function(){e.highlight()},e.settings.typingDelay);e.$element.data("highlighterTimerId",i)},o.prototype.highlight=function(){var t=this,e=t.$element.val(),i=t.settings,s="",o="";0<i.maxlength?(i.maxlength<e.length&&(s=e.slice(i.maxlength,i.maxlength+e.length-1),s=n.escapeHTML(s),s=n.getTextInSpan(i.maxlengthWarning,s)),t.updateCharLimitElement(e),o=e.slice(0,i.maxlength)):o=e,o=n.escapeHTML(o),o=t.getHighlightedContent(o),t.$backgroundDiv.html(o+s),t.updateHeight(),t.$element.trigger("textarea.highlighter.highlight")},o.prototype.getHighlightedContent=function(t){for(var e,i,s=this,o=s.settings.matches,r=[],a=0,l=o.length;l>a;a++){if(e=o[a],!e._trie){e._trie=new marexandre.Trie;for(var h=0,c=e.match.length;c>h;h++)e._trie.add(n.escapeHTML(e.match[h]))}i=e._trie.getIndecies(t),i=n.removeOverlapingIndecies(i),r.push({indecies:i,type:e.matchClass})}var u=n.flattenIndeciesList(r);return u=n.orderBy(u,"start"),u=n.removeOverlapingIndecies(u),u=n.cleanupOnWordBoundary(t,u,s.settings.word_base),n.createHTML(n.makeTokenized(t,u))},o.prototype.updateCharLimitElement=function(t){var e=this,i=e.settings;if(null!==i.maxlengthElement){var s=i.maxlength-t.length;0>s?i.maxlengthElement.hasClass(i.maxlengthWarning)||i.maxlengthElement.addClass(i.maxlengthWarning):i.maxlengthElement.hasClass(i.maxlengthWarning)&&i.maxlengthElement.removeClass(i.maxlengthWarning),i.maxlengthElement.text(s)}},o.prototype.updateMatches=function(t){var e=this;e.settings.matches=t,e.highlight()},o.prototype.updateStyle=function(){var t=this,e=this.$element,i=this.settings,s={paddingTop:parseInt(e.css("padding-top"),10),paddingRight:parseInt(e.css("padding-right"),10),paddingBottom:parseInt(e.css("padding-bottom"),10),paddingLeft:parseInt(e.css("padding-left"),10)};n.browser().iphone&&(s.paddingRight+=3,s.paddingLeft+=3),this.$wrapDiv.css({position:"relative"}),this.$backgroundDiv.css({position:"absolute",height:"100%","font-family":"inherit",color:i.debug?"#f00":"transparent","padding-top":s.paddingTop,"padding-right":s.paddingRight,"padding-bottom":s.paddingBottom,"padding-left":s.paddingLeft}),t.cloneCSSToTarget(t.$backgroundDiv),i.isAutoExpand&&(t.$autoSize.css({top:0,left:0,"font-family":"inherit",position:"absolute","padding-top":s.paddingTop,"padding-right":s.paddingRight,"padding-bottom":s.paddingBottom,"padding-left":s.paddingLeft}),t.cloneCSSToTarget(t.$autoSize)),e.css({color:i.debug?"rgba(0,0,0,0.5)":"inherit",position:"relative",background:"none"})},o.prototype.updateHeight=function(){var t=this;if(t.settings.isAutoExpand){t.$autoSizeElement.html(n.escapeHTML(n.sanitizeBreakLines(t.$element.val()))+" ");var e=t.$autoSize.height();t.$element.height()!==e&&(t.$element.height(e),t.$backgroundDiv.height(e))}},o.prototype.cloneCSSToTarget=function(e){var i=this.$element,s=["lineHeight","textDecoration","letterSpacing","fontSize","fontStyle","fontWeight","textTransform","textAlign","direction","wordSpacing","fontSizeAdjust","wordWrap","word-break","marginLeft","marginRight","marginTop","marginBottom","borderLeftWidth","borderRightWidth","borderTopWidth","borderBottomWidth","boxSizing","webkitBoxSizing","mozBoxSizing","msBoxSizing"],n=null;t.each(s,function(t,s){n=i.css(s),e.css(s)!==n&&e.css(s,n)})},o.prototype.destroy=function(){t.data(this.element,"plugin_"+s,!1),this.$backgroundDiv.remove(),this.$autoSize.remove(),this.$element.data("highlighterTimerId",-1).off("scroll.textarea.highlighter").off("input.textarea.highlighter").off("keyup.textarea.highlighter").off("propertychange.textarea.highlighter").attr("style","").unwrap()},o.prototype.debugModeOn=function(){this.settings.debug=!0,this.$backgroundDiv.css({color:"#f00"}),this.$element.css({color:"rgba(0,0,0,0.5)"})},o.prototype.debugModeOff=function(){this.settings.debug=!1,this.$backgroundDiv.css({color:"transparent"}),this.$element.css({color:"inherit"})},t.fn.textareaHighlighter=function(e){var i=arguments;return this.each(function(){var n=t(this),r=n.data(s),a="object"==typeof e&&e;if(e&&(r||"string"!=typeof e)&&(r||(r=new o(n,a),n.data(s,r)),"string"==typeof e)){if(!r[e])throw"Unknown method: "+e;r[e].apply(r,Array.prototype.slice.call(i,1))}})}}(jQuery,window,document);